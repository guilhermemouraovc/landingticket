async function loadCarnaval() {
  try {
    const response = await api.get('/festas', {
      params: {
        'pagination[pageSize]': 50,
        populate: '*',
      },
    })

    const festas = Array.isArray(response?.data?.data) ? response.data.data : []

    carnavalEvents.value = festas
      .filter((festa) => hasTagCarnavais(festa?.attributes ?? festa ?? {}))
      .map(toFeaturedCard)
  } catch (err) {
    console.error('Falha ao carregar carnaval', err)
    carnavalEvents.value = []
  }
}

function hasTagCarnavais(record) {
  const tags = collectTags(record)
  if (!tags.size) {
    const name = normalizeForSearch(
      firstNonEmptyString(
        record.Nome,
        record.nome,
        record.Titulo,
        record.titulo,
        record.Title,
        record.title,
      ),
    )
    return name.includes('carnaval')
  }
  return tags.has('carnavais') || tags.has('carnaval')
}

function collectTags(record) {
  const out = new Set()
  const candidates = [
    record.tags,
    record.Tags,
    record.tag,
    record.categorias,
    record.Categorias,
    record.categories,
    record.category,
    record.etiquetas,
  ]
  for (const field of candidates) {
    if (!field) continue
    if (typeof field === 'string') {
      field
        .split(/[,;|]/)
        .map((s) => normalizeForSearch(String(s || '')))
        .filter(Boolean)
        .forEach((s) => out.add(s))
      continue
    }
    if (Array.isArray(field)) {
      for (const item of field) {
        if (typeof item === 'string') {
          const v = normalizeForSearch(item)
          if (v) out.add(v)
        } else if (item && typeof item === 'object') {
          const v = normalizeForSearch(
            firstNonEmptyString(
              item.name,
              item.nome,
              item.titulo,
              item.label,
              item.Title,
              item.slug,
            ),
          )
          if (v) out.add(v)
        }
      }
      continue
    }
    const rel = field?.data
    if (Array.isArray(rel)) {
      for (const e of rel) {
        const v = normalizeForSearch(
          firstNonEmptyString(
            e?.attributes?.name,
            e?.attributes?.Nome,
            e?.attributes?.titulo,
            e?.attributes?.label,
          ),
        )
        if (v) out.add(v)
      }
    } else if (rel && typeof rel === 'object') {
      const v = normalizeForSearch(
        firstNonEmptyString(
          rel?.attributes?.name,
          rel?.attributes?.Nome,
          rel?.attributes?.titulo,
          rel?.attributes?.label,
        ),
      )
      if (v) out.add(v)
    }
  }
  return out
}
